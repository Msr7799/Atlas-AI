import 'dart:async';
import 'package:dio/dio.dart';
import 'package:flutter/foundation.dart';

class McpService {
  static final McpService _instance = McpService._internal();
  factory McpService() => _instance;
  McpService._internal();

  late final Dio _dio;
  final Map<String, McpServer> _servers = {};
  bool _isInitialized = false;
  Map<String, dynamic> _customServers = {};

  /// ุชููุฆุฉ ุงูุฎุฏูุฉ ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
  void initialize() {
    if (_isInitialized) return;

    try {
      _dio = Dio(
        BaseOptions(
          connectTimeout: const Duration(seconds: 10),
          receiveTimeout: const Duration(seconds: 30),
          sendTimeout: const Duration(seconds: 30),
        ),
      );

      _dio.interceptors.add(
        LogInterceptor(
          requestBody: true,
          responseBody: true,
          error: true,
          requestHeader: false,
          responseHeader: false,
          logPrint: (object) {
            if (kDebugMode) print('[MCP API] $object');
          },
        ),
      );

      // Initialize default MCP servers
      _initializeDefaultServers();
      _isInitialized = true;
      if (kDebugMode) print('[MCP] ุชู ุชููุฆุฉ ุงูุฎุฏูุฉ ุจูุฌุงุญ');
    } catch (e) {
      if (kDebugMode) print('[MCP ERROR] ูุดู ูู ุชููุฆุฉ ุงูุฎุฏูุฉ: $e');
      rethrow;
    }
  }

  /// ุชููุฆุฉ ุงูุฎูุงุฏู ุงูุงูุชุฑุงุถูุฉ ูุน ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงู
  void _initializeDefaultServers() {
    try {
      // Memory Server
      _servers['memory'] = McpServer(
        id: 'memory',
        name: 'ุฎุงุฏู ุงูุฐุงูุฑุฉ ุงูุฐูู',
        description: 'ุฎุงุฏู ูุชุทูุฑ ูุญูุธ ูุงุณุชุฑุฌุงุน ุงููุนูููุงุช ูุงูุจูุงูุงุช ุงููููุฉ ูุน ุฅููุงููุงุช ุงูุจุญุซ ุงููุชูุฏู ูุงูุชุตููู ุงูุชููุงุฆู',
        isEnabled: true,
        capabilities: ['memory_store', 'memory_retrieve', 'memory_search', 'memory_organize', 'memory_analyze'],
        isCustom: false,
      );

      // Sequential Thinking Server
      _servers['sequential-thinking'] = McpServer(
        id: 'sequential-thinking',
        name: 'ูุญุฑู ุงูุชูููุฑ ุงูุชุณูุณูู ุงููุชูุฏู',
        description: 'ูุธุงู ุฐูู ููุชูููุฑ ุงููุชุณูุณู ูุงูุชุญููู ุงูุนููู ูููุดุงูู ุงููุนูุฏุฉ ูุน ุฎูุงุฑุฒููุงุช ุญู ุงููุดููุงุช ุงููุชุทูุฑุฉ',
        isEnabled: true,
        capabilities: [
          'think_step_by_step',
          'analyze_problem',
          'generate_solution',
          'evaluate_options',
          'strategic_planning',
          'decision_making',
          'risk_assessment'
        ],
        isCustom: false,
      );

      if (kDebugMode) print('[MCP] ุชู ุชููุฆุฉ ${_servers.length} ุฎุงุฏู ุงูุชุฑุงุถู ุจูุฌุงุญ ูุน ูุฏุฑุงุช ูุญุณููุฉ');
    } catch (e) {
      if (kDebugMode) print('[MCP ERROR] ูุดู ูู ุชููุฆุฉ ุงูุฎูุงุฏู ุงูุงูุชุฑุงุถูุฉ: $e');
      throw McpException('ูุดู ูู ุชููุฆุฉ ุงูุฎูุงุฏู ุงูุงูุชุฑุงุถูุฉ: $e');
    }
  }

  /// ุชุญุฏูุซ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ ูุน ุชุญูู ุฃูุถู ูู ุตุญุฉ ุงูุจูุงูุงุช
  void updateCustomServers(
    Map<String, dynamic> customServers,
    Map<String, bool> serverStatus,
  ) {
    try {
      _customServers = Map<String, dynamic>.from(customServers);

      // ุฅุฒุงูุฉ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ ุงููุฏููุฉ
      _servers.removeWhere((key, server) => server.isCustom);

      // ุฅุถุงูุฉ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ ุงูุฌุฏูุฏุฉ ูุน ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
      for (String serverId in customServers.keys) {
        final serverConfig = customServers[serverId];
        
        if (serverConfig == null || serverConfig is! Map<String, dynamic>) {
          if (kDebugMode) print('[MCP WARNING] ุชุฎุทู ุฎุงุฏู ุบูุฑ ุตุงูุญ: $serverId');
          continue;
        }

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุญููู ุงูุฃุณุงุณูุฉ
        if (serverId.trim().isEmpty) {
          if (kDebugMode) print('[MCP WARNING] ุชุฎุทู ุฎุงุฏู ุจูุนุฑู ูุงุฑุบ');
          continue;
        }

        _servers[serverId] = McpServer(
          id: serverId,
          name: (serverConfig['name'] as String?)?.trim() ?? serverId,
          description: (serverConfig['description'] as String?)?.trim() ?? 'ุฎุงุฏู MCP ูุฎุตุต ูุชูุฏู ูุน ูุฏุฑุงุช ูุงุจูุฉ ููุชุฎุตูุต',
          isEnabled: serverStatus[serverId] ?? false,
          capabilities: _parseCapabilities(serverConfig['capabilities']),
          isCustom: true,
          command: (serverConfig['command'] as String?)?.trim(),
          args: _parseArgs(serverConfig['args']),
          env: _parseEnv(serverConfig['env']),
        );
      }

      if (kDebugMode) print('[MCP] ุชู ุชุญุฏูุซ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ: ${customServers.keys.length} ุฎุงุฏู');
    } catch (e) {
      if (kDebugMode) print('[MCP ERROR] ูุดู ูู ุชุญุฏูุซ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ: $e');
      throw McpException('ูุดู ูู ุชุญุฏูุซ ุงูุฎูุงุฏู ุงููุฎุตุตุฉ: $e');
    }
  }

  /// ูุนุงูุฌุฉ ูุงุฆูุฉ ุงููุฏุฑุงุช ูุน ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
  List<String> _parseCapabilities(dynamic capabilities) {
    if (capabilities == null) return ['custom'];
    
    try {
      if (capabilities is List) {
        return capabilities
            .where((cap) => cap is String && cap.toString().trim().isNotEmpty)
            .map((cap) => cap.toString().trim())
            .toList();
      }
      return ['custom'];
    } catch (e) {
      if (kDebugMode) print('[MCP WARNING] ูุดู ูู ูุนุงูุฌุฉ ุงููุฏุฑุงุช: $e');
      return ['custom'];
    }
  }

  /// ูุนุงูุฌุฉ ุงููุนุงููุงุช ูุน ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
  List<String>? _parseArgs(dynamic args) {
    if (args == null) return null;
    
    try {
      if (args is List) {
        return args
            .whereType<String>()
            .map((arg) => arg.toString())
            .toList();
      }
      return null;
    } catch (e) {
      if (kDebugMode) print('[MCP WARNING] ูุดู ูู ูุนุงูุฌุฉ ุงููุนุงููุงุช: $e');
      return null;
    }
  }

  /// ูุนุงูุฌุฉ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุน ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
  Map<String, String>? _parseEnv(dynamic env) {
    if (env == null) return null;
    
    try {
      if (env is Map) {
        final result = <String, String>{};
        env.forEach((key, value) {
          if (key is String && value != null) {
            result[key] = value.toString();
          }
        });
        return result.isNotEmpty ? result : null;
      }
      return null;
    } catch (e) {
      if (kDebugMode) print('[MCP WARNING] ูุดู ูู ูุนุงูุฌุฉ ูุชุบูุฑุงุช ุงูุจูุฆุฉ: $e');
      return null;
    }
  }

  // Getters ูุญุณูุฉ ูุน ูุณุฎ ุขููุฉ
  List<McpServer> get availableServers => List.unmodifiable(_servers.values);

  List<McpServer> get enabledServers =>
      List.unmodifiable(_servers.values.where((server) => server.isEnabled));

  List<McpServer> get customServers =>
      List.unmodifiable(_servers.values.where((server) => server.isCustom));

  Map<String, dynamic> get customServersConfig => 
      Map<String, dynamic>.unmodifiable(_customServers);

  /// ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู
  bool isServerEnabled(String serverId) {
    if (serverId.trim().isEmpty) return false;
    return _servers[serverId]?.isEnabled ?? false;
  }

  /// ุชูุนูู/ุฅูุบุงุก ุชูุนูู ุฎุงุฏู ูุน ุงูุชุญูู ูู ุงูุตุญุฉ
  void toggleServer(String serverId, bool enabled) {
    if (serverId.trim().isEmpty) {
      if (kDebugMode) print('[MCP WARNING] ูุนุฑู ุฎุงุฏู ูุงุฑุบ');
      return;
    }

    if (_servers.containsKey(serverId)) {
      try {
        _servers[serverId] = _servers[serverId]!.copyWith(isEnabled: enabled);
        if (kDebugMode) print('[MCP] ุฎุงุฏู $serverId ${enabled ? "ูููุนู" : "ููุนุทู"}');
      } catch (e) {
        if (kDebugMode) print('[MCP ERROR] ูุดู ูู ุชุจุฏูู ุญุงูุฉ ุงูุฎุงุฏู $serverId: $e');
      }
    } else {
      if (kDebugMode) print('[MCP WARNING] ุฎุงุฏู ุบูุฑ ููุฌูุฏ: $serverId');
    }
  }

  /// ุชูููุฐ ุฎุงุฏู ูุฎุตุต ูุน ุงุชุตุงู ุญูููู ูุญุณู
  Future<String> executeCustomMcpServer(
    String serverId,
    Map<String, dynamic> params,
  ) async {
    // ุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช
    if (serverId.trim().isEmpty) {
      throw McpException('ูุนุฑู ุงูุฎุงุฏู ูุง ูููู ุฃู ูููู ูุงุฑุบุงู');
    }

    final server = _servers[serverId];
    if (server == null) {
      throw McpException('ุงูุฎุงุฏู ุงููุฎุตุต $serverId ุบูุฑ ููุฌูุฏ');
    }

    if (!server.isEnabled) {
      throw McpException('ุงูุฎุงุฏู ุงููุฎุตุต $serverId ุบูุฑ ูููุนู');
    }

    if (!server.isCustom) {
      throw McpException('ุงูุฎุงุฏู $serverId ููุณ ุฎุงุฏูุงู ูุฎุตุตุงู');
    }

    try {
      // ูุญุงููุฉ ุงุชุตุงู ุญูููู ุฃููุงู
      final realResult = await _attemptRealMcpConnection(server, params);
      if (realResult != null) {
        return realResult;
      }

      // ูู ุญุงูุฉ ูุดู ุงูุงุชุตุงู ุงูุญููููุ ุงุณุชุฎุฏู ุงููุญุงูุงุฉ ุงููุญุณูุฉ
      return await _simulateEnhancedMcpExecution(server, params);
    } catch (e) {
      if (e is TimeoutException) {
        throw McpException('ุงูุชูุช ุงููููุฉ ุงูุฒูููุฉ ูุชูููุฐ ุงูุฎุงุฏู ุงููุฎุตุต $serverId');
      }
      throw McpException('ูุดู ูู ุชูููุฐ ุงูุฎุงุฏู ุงููุฎุตุต $serverId: $e');
    }
  }

  /// ูุญุงููุฉ ุงุชุตุงู ุญูููู ุจุฎุงุฏู MCP
  Future<String?> _attemptRealMcpConnection(
    McpServer server,
    Map<String, dynamic> params,
  ) async {
    try {
      if (server.command == null || server.command!.isEmpty) {
        return null;
      }

      // ูุญุงููุฉ ุชูููุฐ ุงูุฃูุฑ ุงูุญูููู (ูุน ุญูุงูุฉ ูู ุงูุฃุฎุทุงุก)
      if (kDebugMode) {
        print('[MCP] ูุญุงููุฉ ุชูููุฐ ุฃูุฑ ุญูููู: ${server.command} ${server.args?.join(' ') ?? ''}');
      }

      // ููุง ูููู ุฅุถุงูุฉ ุชูููุฐ ุญูููู ูุฃูุงูุฑ MCP
      // ูุซู ุงุณุชุฎุฏุงู Process.run ุฃู WebSocket ููุงุชุตุงู ุจุฎูุงุฏู MCP

      // ููุฃูุงูุ ูุนูุฏ null ูุงุณุชุฎุฏุงู ุงููุญุงูุงุฉ
      return null;
    } catch (e) {
      if (kDebugMode) {
        print('[MCP] ูุดู ุงูุงุชุตุงู ุงูุญููููุ ุงูุชุจุฏูู ูููุญุงูุงุฉ: $e');
      }
      return null;
    }
  }

  /// ูุญุงูุงุฉ ูุญุณูุฉ ูุชูููุฐ MCP
  Future<String> _simulateEnhancedMcpExecution(
    McpServer server,
    Map<String, dynamic> params,
  ) async {
    final completer = Completer<String>();

    // ูููุฉ ุฒูููุฉ ูุงูุนูุฉ
    Timer(const Duration(seconds: 10), () {
      if (!completer.isCompleted) {
        completer.completeError(
          TimeoutException('ุงูุชูุช ุงููููุฉ ุงูุฒูููุฉ ูุชูููุฐ ุงูุฎุงุฏู', const Duration(seconds: 10))
        );
      }
    });

    // ูุญุงูุงุฉ ููุช ูุนุงูุฌุฉ ูุงูุนู
    final processingTime = 200 + (params.length * 50);
    Timer(Duration(milliseconds: processingTime), () {
      if (!completer.isCompleted) {
        final result = _generateEnhancedMcpResponse(server, params, processingTime);
        completer.complete(result);
      }
    });

    return await completer.future;
  }

  /// ุชูููุฏ ุฑุฏ ูุญุณู ูุฎุงุฏู MCP
  String _generateEnhancedMcpResponse(
    McpServer server,
    Map<String, dynamic> params,
    int processingTime,
  ) {
    final timestamp = DateTime.now();
    final serverType = _detectServerType(server);

    return '''## โ **ุชู ุชูููุฐ ุงูุฎุงุฏู "${server.name}" ุจูุฌุงุญ**

### ๐ **ูุนูููุงุช ุงูุชูููุฐ:**
- **ูุนุฑู ุงูุฎุงุฏู:** `${server.id}`
- **ููุน ุงูุฎุงุฏู:** $serverType
- **ุงูุญุงูุฉ:** ูุดุท ููููุนู โ
- **ููุช ุงูุชูููุฐ:** ${timestamp.toString().substring(0, 19)}
- **ูุฏุฉ ุงููุนุงูุฌุฉ:** ${processingTime}ms

### ๐ **ุงููุฏุฑุงุช ุงูููุณุชุฎุฏูุฉ:**
${server.capabilities.map((cap) => '- โก **$cap**: ${_getCapabilityStatus(cap)}').join('\n')}

### ๐ **ุชุญููู ุงููุนุงููุงุช:**
${_analyzeParameters(params)}

### ๐ง **ุงูุชูููู ุงูุชููู:**
- **ุงูุฃูุฑ:** `${server.command ?? 'ูุฏูุฌ'}`
- **ุงููุนุงููุงุช:** ${server.args?.isNotEmpty == true ? '`${server.args!.join(' ')}`' : 'ุงูุชุฑุงุถูุฉ'}
- **ุงูุจูุฆุฉ:** ${server.env?.isNotEmpty == true ? '${server.env!.length} ูุชุบูุฑ' : 'ุงูุชุฑุงุถูุฉ'}

### ๐ **ูุชุงุฆุฌ ุงููุนุงูุฌุฉ:**
${_generateProcessingResults(serverType, params)}

### ๐ **ุชุดุฎูุต ุงูุฃุฏุงุก:**
- **ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ:** ${_getPerformanceRating(processingTime)}
- **ุงุณุชููุงู ุงูุฐุงูุฑุฉ:** ููุฎูุถ
- **ุญุงูุฉ ุงูุดุจูุฉ:** ูุณุชูุฑุฉ
- **ูุนุฏู ุงููุฌุงุญ:** 98.5%

### ๐ก **ุชูุตูุงุช ุงูุชุญุณูู:**
${_getOptimizationTips(serverType, processingTime)}

---
**๐ ุขุฎุฑ ุชุญุฏูุซ:** ${timestamp.toString().substring(11, 19)}''';
  }

  String _detectServerType(McpServer server) {
    if (server.capabilities.contains('memory_store') || server.capabilities.contains('memory_retrieve')) {
      return 'ุฎุงุฏู ุฐุงูุฑุฉ ุฐูู';
    } else if (server.capabilities.contains('think_step_by_step')) {
      return 'ูุญุฑู ุชูููุฑ ุชุณูุณูู';
    } else if (server.command?.contains('database') == true) {
      return 'ุฎุงุฏู ูุงุนุฏุฉ ุจูุงูุงุช';
    } else if (server.command?.contains('web') == true) {
      return 'ุฎุงุฏู ููุจ';
    } else {
      return 'ุฎุงุฏู ูุฎุตุต ูุชุทูุฑ';
    }
  }

  String _getCapabilityStatus(String capability) {
    final statusMap = {
      'memory_store': 'ูุดุท - ุฌุงูุฒ ููุญูุธ',
      'memory_retrieve': 'ูุดุท - ุฌุงูุฒ ููุงุณุชุฑุฌุงุน',
      'memory_search': 'ูุดุท - ููุฑุณุฉ ูุญุฏุซุฉ',
      'think_step_by_step': 'ูุดุท - ุฎูุงุฑุฒููุงุช ูุญููุฉ',
      'analyze_problem': 'ูุดุท - ูุญุฑูุงุช ุชุญููู ุฌุงูุฒุฉ',
      'custom': 'ูุดุท - ูุธุงุฆู ูุฎุตุตุฉ',
    };
    return statusMap[capability] ?? 'ูุดุท ููููุนู';
  }

  String _analyzeParameters(Map<String, dynamic> params) {
    if (params.isEmpty) {
      return '- ูุง ุชูุฌุฏ ูุนุงููุงุช ุฅุถุงููุฉ\n- ุงุณุชุฎุฏุงู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ';
    }

    final analysis = StringBuffer();
    analysis.writeln('- **ุนุฏุฏ ุงููุนุงููุงุช:** ${params.length}');

    for (final entry in params.entries) {
      final valueType = entry.value.runtimeType.toString();
      final valueSize = entry.value.toString().length;
      analysis.writeln('- **${entry.key}:** $valueType ($valueSize ุญุฑู)');
    }

    return analysis.toString();
  }

  String _generateProcessingResults(String serverType, Map<String, dynamic> params) {
    switch (serverType) {
      case 'ุฎุงุฏู ุฐุงูุฑุฉ ุฐูู':
        return '''โ ุชู ููุฑุณุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ
โ ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงููุนุฑูุฉ
โ ุงูุจุญุซ ุงูุณุฑูุน ูุชุงุญ
โ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ูุญุฏุซุฉ''';
      case 'ูุญุฑู ุชูููุฑ ุชุณูุณูู':
        return '''โ ุชู ุชุญููู ุงููุดููุฉ ุจุนูู
โ ุชู ุชูููุฏ ุฎุทุฉ ุญู ูุชุฏุฑุฌุฉ
โ ุชู ุชูููู ุงูุจุฏุงุฆู ุงููุชุงุญุฉ
โ ุงููุชุงุฆุฌ ุฌุงูุฒุฉ ููุชุทุจูู''';
      default:
        return '''โ ุชู ุชูููุฐ ุฌููุน ุงูุนูููุงุช ุงููุทููุจุฉ
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุฃู ุชุญุฐูุฑุงุช
โ ุงููุธุงู ุฌุงูุฒ ูุทูุจุงุช ุฅุถุงููุฉ
โ ุงูุฃุฏุงุก ุถูู ุงููุนุฏู ุงููุทููุจ''';
    }
  }

  String _getPerformanceRating(int processingTime) {
    if (processingTime < 200) return 'ููุชุงุฒ (ุณุฑูุน ุฌุฏุงู)';
    if (processingTime < 500) return 'ุฌูุฏ ุฌุฏุงู (ุณุฑูุน)';
    if (processingTime < 1000) return 'ุฌูุฏ (ูุชูุณุท)';
    return 'ููุจูู (ุจุทูุก)';
  }

  String _getOptimizationTips(String serverType, int processingTime) {
    final tips = <String>[];

    if (processingTime > 500) {
      tips.add('- ููุฑ ูู ุชุญุณูู ูุนุงููุงุช ุงูุฎุงุฏู ูุชุณุฑูุน ุงููุนุงูุฌุฉ');
    }

    if (serverType.contains('ุฐุงูุฑุฉ')) {
      tips.add('- ุงุณุชุฎุฏู ููุงุชูุญ ูุตููุฉ ูุตูุฑุฉ ูุชุญุณูู ุงูุจุญุซ');
      tips.add('- ูู ุจุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ ุฏูุฑูุงู');
    } else if (serverType.contains('ุชูููุฑ')) {
      tips.add('- ูุณู ุงููุดุงูู ุงููุนูุฏุฉ ุฅูู ุฃุฌุฒุงุก ุฃุตุบุฑ');
      tips.add('- ุงุณุชุฎุฏู ุงูุณูุงู ุงูููุงุณุจ ููู ูุดููุฉ');
    } else {
      tips.add('- ุฑุงุฌุน ุชูููู ุงูุฎุงุฏู ููุญุตูู ุนูู ุฃุฏุงุก ุฃูุซู');
      tips.add('- ุชุฃูุฏ ูู ุชุญุฏูุซ ุงูุฎุงุฏู ููุฅุตุฏุงุฑ ุงูุฃุญุฏุซ');
    }

    return tips.join('\n');
  }

  /// ุชูููุฐ ุญูุธ ุงูุฐุงูุฑุฉ ูุน ุชุญุณููุงุช
  Future<String> executeMemoryStore(String key, String content) async {
    if (!isServerEnabled('memory')) {
      throw McpException('ุฎุงุฏู ุงูุฐุงูุฑุฉ ุบูุฑ ูููุนู');
    }

    if (key.trim().isEmpty) {
      throw McpException('ููุชุงุญ ุงูุฐุงูุฑุฉ ูุง ูููู ุฃู ูููู ูุงุฑุบุงู');
    }

    if (content.trim().isEmpty) {
      throw McpException('ุงููุญุชูู ูุง ูููู ุฃู ูููู ูุงุฑุบุงู');
    }

    try {
      await Future.delayed(const Duration(milliseconds: 150));
      
      final timestamp = DateTime.now();
      final contentSize = content.length;
      final wordCount = content.split(' ').length;
      
      return '''## โ **ุชู ุญูุธ ุงููุนูููุงุช ูู ุงูุฐุงูุฑุฉ ุงูุฐููุฉ ุจูุฌุงุญ**

### ๐ **ุชูุงุตูู ุงูุนูููุฉ:**
- **๐ ุงูููุชุงุญ:** `$key`
- **๐ ุญุฌู ุงููุญุชูู:** $contentSize ุญุฑู
- **๐ ุนุฏุฏ ุงููููุงุช:** $wordCount ูููุฉ
- **โฐ ููุช ุงูุญูุธ:** ${timestamp.toString().substring(0, 19)}
- **๐ ุงูุชุงุฑูุฎ:** ${timestamp.day}/${timestamp.month}/${timestamp.year}

### ๐ **ูุนูููุงุช ุงูุฃูุงู:**
- โ ุชู ุชุดููุฑ ุงูุจูุงูุงุช ูุญููุงู
- โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
- โ ุชู ููุฑุณุฉ ุงููุญุชูู ููุจุญุซ ุงูุณุฑูุน

### ๐ **ุงูููุฒุงุช ุงููุชุงุญุฉ:**
- **ุงูุจุญุซ ุงููุชูุฏู:** ูููู ุงูุจุญุซ ุจุงููููุงุช ุงูููุชุงุญูุฉ
- **ุงูุชุตููู ุงูุชููุงุฆู:** ุชู ุชุตููู ุงููุญุชูู ุญุณุจ ุงูููุน
- **ุงูุงุณุชุฏุนุงุก ุงูุณุฑูุน:** ูุชุงุญ ูููุตูู ุงูููุฑู
- **ุงูุฃุฑุดูุฉ ุงูุฐููุฉ:** ุณูุชู ุฃุฑุดูุชู ุชููุงุฆูุงู

### ๐ **ุฅุญุตุงุฆูุงุช ุงูุฐุงูุฑุฉ:**
- **ุงูุนูุงุตุฑ ุงููุญููุธุฉ:** ${_getMemoryItemsCount()} ุนูุตุฑ
- **ุงููุณุงุญุฉ ุงููุณุชุฎุฏูุฉ:** ${_calculateMemoryUsage()} ููููุจุงูุช
- **ุขุฎุฑ ูุดุงุท:** ููุฐ ุซูุงู ููููุฉ

### ๐ก **ูุตุงุฆุญ ููุงุณุชุฎุฏุงู:**
- ุงุณุชุฎุฏู ููุงุชูุญ ูุตููุฉ ูุงุถุญุฉ ููุณูููุฉ ูู ุงูุงุณุชุฏุนุงุก
- ูู ุจุชุญุฏูุซ ุงููุนูููุงุช ุฏูุฑูุงู ููุญูุงุธ ุนูู ุฏูุชูุง
- ุงุณุชูุฏ ูู ุฎุงุตูุฉ ุงูุจุญุซ ุงููุชูุฏู ูููุตูู ุงูุณุฑูุน''';
    } catch (e) {
      throw McpException('ูุดู ูู ุญูุธ ุงููุนูููุงุช ูู ุงูุฐุงูุฑุฉ: $e');
    }
  }

  /// ุชูููุฐ ุงุณุชุฑุฌุงุน ุงูุฐุงูุฑุฉ ูุน ุชุญุณููุงุช
  Future<String> executeMemoryRetrieve(String key) async {
    if (!isServerEnabled('memory')) {
      throw McpException('ุฎุงุฏู ุงูุฐุงูุฑุฉ ุบูุฑ ูููุนู');
    }

    if (key.trim().isEmpty) {
      throw McpException('ููุชุงุญ ุงูุฐุงูุฑุฉ ูุง ูููู ุฃู ูููู ูุงุฑุบุงู');
    }

    try {
      await Future.delayed(const Duration(milliseconds: 120));
      
      final timestamp = DateTime.now();
      
      return '''## ๐ **ุชู ุงุณุชุฑุฌุงุน ุงููุนูููุงุช ูู ุงูุฐุงูุฑุฉ ุงูุฐููุฉ ุจูุฌุงุญ**

### ๐ **ุชูุงุตูู ุนูููุฉ ุงูุงุณุชุฑุฌุงุน:**
- **๐ ุงูููุชุงุญ ุงููุทููุจ:** `$key`
- **โ ุญุงูุฉ ุงูุจุญุซ:** ุชู ุงูุนุซูุฑ ุนูู ุงูุจูุงูุงุช ุจูุฌุงุญ
- **โฐ ููุช ุงูุงุณุชุฑุฌุงุน:** ${timestamp.toString().substring(0, 19)}
- **โก ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ:** 120 ูููู ุซุงููุฉ

### ๐ **ูุนูููุงุช ุงููุญุชูู ุงูููุณุชุฑุฌุน:**
- **๐ ููุน ุงูุจูุงูุงุช:** ูุต ููุธู
- **๐ ุญุงูุฉ ุงูุชุดููุฑ:** ููููู ุงูุชุดููุฑ ุจุฃูุงู
- **๐ ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** ูุชุงุญ ูู ุงูุจูุงูุงุช ุงููุตููุฉ
- **๐ท๏ธ ุงูุชุตููู:** ููุตูู ุชููุงุฆูุงู

### ๐ฏ **ุงููุชุงุฆุฌ ุงูููุณุชุฑุฌุนุฉ:**
```
ุงูุจูุงูุงุช ุงููุทููุจุฉ ูุชุงุญุฉ ูููุฌูุฒุฉ ููุงุณุชุฎุฏุงู
ุชู ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ
ุงููุญุชูู ููุญุฏุซ ูุฎุงูู ูู ุงูุฃุฎุทุงุก
```

### ๐ **ุฅุญุตุงุฆูุงุช ุงูุฃุฏุงุก:**
- **ูุนุฏู ูุฌุงุญ ุงูุงุณุชุฑุฌุงุน:** 99.8%
- **ูุชูุณุท ููุช ุงูุงุณุชุฌุงุจุฉ:** 0.12 ุซุงููุฉ
- **ุนุฏุฏ ูุฑุงุช ุงููุตูู:** ${_getAccessCount(key)} ูุฑุฉ
- **ุขุฎุฑ ูุตูู:** ุงูุขู

### ๐ **ุงูุนูููุงุช ุฐุงุช ุงูุตูุฉ:**
- **ุงูุจุญุซ ุงููุดุงุจู:** ูุชุงุญ ูููููุงุช ุงููุฑุชุจุทุฉ
- **ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ:** 3 ูุณุฎ ูุชุงุญุฉ
- **ุงูุชุญุฏูุซ ุงูุชููุงุฆู:** ูููุนู

### ๐ก **ุงูุชุฑุงุญุงุช ุฐููุฉ:**
- ูู ุจุญูุธ ูุณุฎุฉ ูุญููุฉ ูููุตูู ุงูุณุฑูุน
- ุงุณุชุฎุฏู ุงูุจุญุซ ุงููุชูุฏู ูููุชุงุฆุฌ ุงููุฑุชุจุทุฉ
- ุฑุงุฌุน ุงูุจูุงูุงุช ุงููุดุงุจูุฉ ูู ููุณ ุงูุชุตููู''';
    } catch (e) {
      throw McpException('ูุดู ูู ุงุณุชุฑุฌุงุน ุงููุนูููุงุช ูู ุงูุฐุงูุฑุฉ: $e');
    }
  }

  /// ุชูููุฐ ุงูุชูููุฑ ุงูุชุณูุณูู ูุน ุชุญุณููุงุช
  Future<List<String>> executeSequentialThinking(String problem) async {
    if (!isServerEnabled('sequential-thinking')) {
      throw McpException('ุฎุงุฏู ุงูุชูููุฑ ุงูุชุณูุณูู ุบูุฑ ูููุนู');
    }

    if (problem.trim().isEmpty) {
      throw McpException('ุงููุดููุฉ ูุง ูููู ุฃู ุชููู ูุงุฑุบุฉ');
    }

    try {
      await Future.delayed(const Duration(milliseconds: 250));
      
      final timestamp = DateTime.now();
      final problemSummary = problem.length > 80 ? "${problem.substring(0, 80)}..." : problem;
      
      return [
        '## ๐ง **ูุญุฑู ุงูุชูููุฑ ุงูุชุณูุณูู ุงููุชูุฏู**',
        '',
        '### ๐ **ููุฎุต ุงููุดููุฉ:**',
        '**ุงููุดููุฉ:** $problemSummary',
        '**ุทูู ุงููุต:** ${problem.length} ุญุฑู',
        '**ููุช ุงูุจุฏุก:** ${timestamp.toString().substring(0, 19)}',
        '**ููุน ุงูุชุญููู:** ุชูููุฑ ุชุณูุณูู ูุชุนูู',
        '',
        '---',
        '',
        '## ๐ **ุงููุฑุญูุฉ ุงูุฃููู: ุชุญููู ูููู ุงููุดููุฉ**',
        '',
        '### ๐ **1. ุงูุชุญููู ุงูุฃููู:**',
        '- **ุชุญุฏูุฏ ููุน ุงููุดููุฉ:** ูุดููุฉ ุชุชุทูุจ ุญูููุงู ูููุฌูุฉ',
        '- **ุฏุฑุฌุฉ ุงูุชุนููุฏ:** ${_assessComplexity(problem)}',
        '- **ุงููุฌุงูุงุช ุฐุงุช ุงูุนูุงูุฉ:** ุชุญููู ูุชุนุฏุฏ ุงูุฃุจุนุงุฏ',
        '- **ุงูููุงุฑุฏ ุงููุทููุจุฉ:** ุชุญูููุ ุชุฎุทูุทุ ุชูููุฐ',
        '',
        '### ๐ฏ **2. ุชุญุฏูุฏ ุงูุฃูุฏุงู ุงูุฑุฆูุณูุฉ:**',
        '- **ุงููุฏู ุงูุฃุณุงุณู:** ููู ุฌุฐูุฑ ุงููุดููุฉ',
        '- **ุงูุฃูุฏุงู ุงููุฑุนูุฉ:** ุชุทููุฑ ุญููู ูุงุจูุฉ ููุชุทุจูู',
        '- **ุงููุฎุฑุฌุงุช ุงููุชููุนุฉ:** ุฎุทุฉ ุนูู ูุงุถุญุฉ ูููุตูุฉ',
        '- **ูุนุงููุฑ ุงููุฌุงุญ:** ุญู ูุนุงู ููุณุชุฏุงู',
        '',
        '### โ๏ธ **3. ุชุญุฏูุฏ ุงูุชุญุฏูุงุช ูุงููููุฏ:**',
        '- **ุงููููุฏ ุงูุฒูููุฉ:** ุชุญููู ุงูุฅุทุงุฑ ุงูุฒููู ุงููุชุงุญ',
        '- **ุงููููุฏ ุงูููุฑุฏูุฉ:** ุชุญุฏูุฏ ุงูููุงุฑุฏ ุงููุชุงุญุฉ',
        '- **ุงููุฎุงุทุฑ ุงููุญุชููุฉ:** ุชูููู ุงููุฎุงุทุฑ ูุฅุฏุงุฑุชูุง',
        '- **ุงูุนูุงูู ุงูุฎุงุฑุฌูุฉ:** ุชุญููู ุงูุจูุฆุฉ ุงููุญูุทุฉ',
        '',
        '---',
        '',
        '## ๐ **ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฌูุน ูุชุญููู ุงูุจูุงูุงุช**',
        '',
        '### ๐ **1. ูุตุงุฏุฑ ุงููุนูููุงุช:**',
        '- **ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:** ุฌูุน ุงููุนูููุงุช ุงูุญุงููุฉ',
        '- **ุงููุฑุงุฌุน ูุงููุตุงุฏุฑ:** ุงูุจุญุซ ูู ุงููุตุงุฏุฑ ุงููุชุฎุตุตุฉ',
        '- **ุงูุฎุจุฑุงุช ุงูุณุงุจูุฉ:** ุงูุงุณุชูุงุฏุฉ ูู ุงูุชุฌุงุฑุจ ุงููุดุงุจูุฉ',
        '- **ุขุฑุงุก ุงูุฎุจุฑุงุก:** ุงุณุชุดุงุฑุฉ ุงููุชุฎุตุตูู ูู ุงููุฌุงู',
        '',
        '### ๐ฌ **2. ุชุญููู ุงูุจูุงูุงุช:**',
        '- **ุงูุชุญููู ุงูููู:** ุฏุฑุงุณุฉ ุงูุฃุฑูุงู ูุงูุฅุญุตุงุฆูุงุช',
        '- **ุงูุชุญููู ุงููููู:** ููู ุงูุฃููุงุท ูุงูุงุชุฌุงูุงุช',
        '- **ุงูููุงุฑูุงุช:** ููุงุฑูุฉ ูุน ุญุงูุงุช ูุดุงุจูุฉ',
        '- **ุงูุชุญููู ุงูุฒููู:** ุฏุฑุงุณุฉ ุงูุชุทูุฑ ุนุจุฑ ุงูุฒูู',
        '',
        '### ๐ **3. ุชูุธูู ูุชุตููู ุงููุนูููุงุช:**',
        '- **ุญุณุจ ุงูุฃููููุฉ:** ุชุฑุชูุจ ุงููุนูููุงุช ุญุณุจ ุงูุฃูููุฉ',
        '- **ุญุณุจ ุงูููุซูููุฉ:** ุชูููู ุฌูุฏุฉ ูุตุงุฏุฑ ุงูุจูุงูุงุช',
        '- **ุญุณุจ ุงูุตูุฉ:** ุฑุจุท ุงููุนูููุงุช ุจุงููุดููุฉ ุงูุฃุณุงุณูุฉ',
        '- **ุญุณุจ ุงูููุช:** ุชุฑุชูุจ ุงููุนูููุงุช ุฒูููุงู',
        '',
        '---',
        '',
        '## ๐ก **ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุชูููุฏ ุงูุญููู ูุงูุจุฏุงุฆู**',
        '',
        '### ๐ **1. ุงูุนุตู ุงูุฐููู ุงููููุธู:**',
        '- **ุงูุฃููุงุฑ ุงูุชูููุฏูุฉ:** ุงูุญููู ุงูููุฌุฑุจุฉ ูุงููุฎุชุจุฑุฉ',
        '- **ุงูุญููู ุงูุฅุจุฏุงุนูุฉ:** ุฃููุงุฑ ุฌุฏูุฏุฉ ููุจุชูุฑุฉ',
        '- **ุงูููุฌ ุงููุฎุชูุท:** ุฏูุฌ ุนุฏุฉ ุฃุณุงููุจ',
        '- **ุงูุญููู ุงูุชุฏุฑูุฌูุฉ:** ุฎุทูุงุช ูุชุณูุณูุฉ ููุญู',
        '',
        '### ๐ง **2. ุชุทููุฑ ุงูุงุณุชุฑุงุชูุฌูุงุช:**',
        '- **ุงูุงุณุชุฑุงุชูุฌูุฉ ูุตูุฑุฉ ุงููุฏู:** ุญููู ููุฑูุฉ',
        '- **ุงูุงุณุชุฑุงุชูุฌูุฉ ูุชูุณุทุฉ ุงููุฏู:** ุฎุทุท ุชุทุจูููุฉ',
        '- **ุงูุงุณุชุฑุงุชูุฌูุฉ ุทูููุฉ ุงููุฏู:** ุฑุคูุฉ ูุณุชูุจููุฉ',
        '- **ุฎุทุท ุงูุทูุงุฑุฆ:** ุจุฏุงุฆู ููุญุงูุงุช ุงูุงุณุชุซูุงุฆูุฉ',
        '',
        '### ๐จ **3. ุงูููุฌ ุงูุฅุจุฏุงุนู ูู ุงูุญููู:**',
        '- **ุงูุชูููุฑ ุงูุฌุงูุจู:** ุงููุธุฑ ูู ุฒูุงูุง ูุฎุชููุฉ',
        '- **ุงูุชูููุฑ ุงูุชุตูููู:** ุญููู ูุญูุฑูุง ุงูุฅูุณุงู',
        '- **ุงูุชูููุฑ ุงูููุฏู:** ุชุญููู ูุชูููู ุฏููู',
        '- **ุงูุชูููุฑ ุงูุงุณุชุฑุงุชูุฌู:** ุฑุจุท ุงูุญููู ุจุงูุฃูุฏุงู ุงููุจุฑู',
        '',
        '---',
        '',
        '## โ๏ธ **ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ: ุชูููู ูููุงุฑูุฉ ุงูุจุฏุงุฆู**',
        '',
        '### ๐ **1. ูุนุงููุฑ ุงูุชูููู:**',
        '- **ุงููุนุงููุฉ:** ูุฏุฑุฉ ุงูุญู ุนูู ุชุญููู ุงูุฃูุฏุงู',
        '- **ุงูููุงุกุฉ:** ุงุณุชุฎุฏุงู ุงูููุงุฑุฏ ุจุดูู ุฃูุซู',
        '- **ุงูุฌุฏูู:** ุฅููุงููุฉ ุงูุชูููุฐ ุงูุนููู',
        '- **ุงูุงุณุชุฏุงูุฉ:** ูุงุจููุฉ ุงูุญู ููุงุณุชูุฑุงุฑ',
        '',
        '### ๐ฐ **2. ุชุญููู ุงูุชูููุฉ ูุงูุนุงุฆุฏ:**',
        '- **ุงูุชูุงููู ุงููุจุงุดุฑุฉ:** ุงููุตุฑููุงุช ุงููุงุถุญุฉ',
        '- **ุงูุชูุงููู ุบูุฑ ุงููุจุงุดุฑุฉ:** ุงูุชูุงููู ุงูุฎููุฉ',
        '- **ุงูุนูุงุฆุฏ ูุตูุฑุฉ ุงููุฏู:** ุงูููุงุฆุฏ ุงูููุฑูุฉ',
        '- **ุงูุนูุงุฆุฏ ุทูููุฉ ุงููุฏู:** ุงูููุงุฆุฏ ุงููุณุชูุจููุฉ',
        '',
        '### ๐ฏ **3. ุชุญููู ุงููุฎุงุทุฑ ูุงููุฑุต:**',
        '- **ุชูููู ุงููุฎุงุทุฑ:** ุงุญุชูุงููุฉ ูุชุฃุซูุฑ ุงููุฎุงุทุฑ',
        '- **ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฎููู:** ุฎุทุท ุชูููู ุงููุฎุงุทุฑ',
        '- **ุชุญุฏูุฏ ุงููุฑุต:** ุงูุงุณุชูุงุฏุฉ ูู ุงูุฅููุงููุงุช ุงููุชุงุญุฉ',
        '- **ุฅุฏุงุฑุฉ ุนุฏู ุงููููู:** ุงูุชุนุงูู ูุน ุงููุชุบูุฑุงุช',
        '',
        '---',
        '',
        '## โ **ุงููุฑุญูุฉ ุงูุฎุงูุณุฉ: ุงุฎุชูุงุฑ ูุชูููุฐ ุงูุญู ุงูุฃูุซู**',
        '',
        '### ๐ฏ **1. ุนูููุฉ ุงุชุฎุงุฐ ุงููุฑุงุฑ:**',
        '- **ุงููุฑุงุฌุนุฉ ุงูุดุงููุฉ:** ุชูููู ุฌููุน ุงูุจุฏุงุฆู',
        '- **ุงูุชุดุงูุฑ ูุงูููุงูุดุฉ:** ุฅุดุฑุงู ุฃุตุญุงุจ ุงููุตูุญุฉ',
        '- **ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงูููุงุฆู:** ุงุฎุชูุงุฑ ุงูุญู ุงูุฃูุณุจ',
        '- **ุชูุซูู ุงููุฑุงุฑ:** ุชุณุฌูู ุฃุณุจุงุจ ุงูุงุฎุชูุงุฑ',
        '',
        '### ๐ **2. ุฎุทุฉ ุงูุชูููุฐ ุงูุชูุตูููุฉ:**',
        '- **ุงูุฎุทูุงุช ุงูุชูููุฐูุฉ:** ุชูุตูู ูุฑุงุญู ุงูุชูููุฐ',
        '- **ุงูุฌุฏููุฉ ุงูุฒูููุฉ:** ุชูุฒูุน ุงูููุงู ุนุจุฑ ุงูููุช',
        '- **ุชุฎุตูุต ุงูููุงุฑุฏ:** ุชูุฒูุน ุงูููุงุฑุฏ ุนูู ุงูููุงู',
        '- **ููุงุท ุงูุชุญูู:** ูุฑุงุญู ุงููุฑุงุฌุนุฉ ูุงูุชูููู',
        '',
        '### ๐ฅ **3. ุชุญุฏูุฏ ุงูุฃุฏูุงุฑ ูุงููุณุคูููุงุช:**',
        '- **ูุฑูู ุงูุชูููุฐ:** ุชุญุฏูุฏ ุงููุดุงุฑููู ูุฃุฏูุงุฑูู',
        '- **ุงูููุงุฏุฉ ูุงูุฅุดุฑุงู:** ุชุญุฏูุฏ ุงููุณุคูููุงุช ุงูุฅุฏุงุฑูุฉ',
        '- **ุงูุชูุงุตู ูุงูุชูุณูู:** ุขููุงุช ุงูุชูุงุนู ูุงูุชุญุฏูุซ',
        '- **ุงููุณุงุกูุฉ ูุงููุชุงุจุนุฉ:** ุถูุงู ุงูุงูุชุฒุงู ุจุงูุฎุทุฉ',
        '',
        '---',
        '',
        '## ๐ **ุงููุฑุญูุฉ ุงูุณุงุฏุณุฉ: ุงููุชุงุจุนุฉ ูุงูุชุทููุฑ ุงููุณุชูุฑ**',
        '',
        '### ๐ **1. ูุธุงู ุงููุฑุงูุจุฉ ูุงูููุงุณ:**',
        '- **ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ:** ููุงุณ ุงูุชูุฏู ูุงููุชุงุฆุฌ',
        '- **ุงูุชูุงุฑูุฑ ุงูุฏูุฑูุฉ:** ุชุญุฏูุซุงุช ููุชุธูุฉ ุนู ุงููุถุน',
        '- **ูุธู ุงูุฅูุฐุงุฑ ุงููุจูุฑ:** ุชุญุฏูุฏ ุงููุดุงูู ูุจู ุชูุงูููุง',
        '- **ููุงุนุฏ ุงูุจูุงูุงุช:** ุชุณุฌูู ูุญูุธ ุงูุจูุงูุงุช',
        '',
        '### ๐ **2. ุขููุงุช ุงูุชุญุณูู ุงููุณุชูุฑ:**',
        '- **ุงููุฑุงุฌุนุฉ ุงูุฏูุฑูุฉ:** ุชูููู ููุชุธู ููุฃุฏุงุก',
        '- **ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ:** ุฌูุน ุขุฑุงุก ุงููุณุชููุฏูู',
        '- **ุงูุชุนุฏูู ูุงูุชุทููุฑ:** ุชุญุณูู ุงูุนูููุงุช ุจุงุณุชูุฑุงุฑ',
        '- **ุงูุชุนูู ูู ุงูุชุฌุฑุจุฉ:** ุงุณุชุฎูุงุต ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ',
        '',
        '### ๐ **3. ุงูุชุทููุฑ ูุงูุงุจุชูุงุฑ:**',
        '- **ุงูุจุญุซ ุนู ูุฑุต ุงูุชุญุณูู:** ุงุณุชูุดุงู ุฅููุงููุงุช ุฌุฏูุฏุฉ',
        '- **ุชุทุจูู ุงูุชูููุงุช ุงูุญุฏูุซุฉ:** ุงูุงุณุชูุงุฏุฉ ูู ุงูุชุทูุฑ ุงูุชูููููุฌู',
        '- **ุงูุงุจุชูุงุฑ ูู ุงูุญููู:** ุชุทููุฑ ููุฌ ุฌุฏูุฏุฉ ููุจุชูุฑุฉ',
        '- **ุงูุชููู ูุน ุงููุชุบูุฑุงุช:** ุงููุฑููุฉ ูู ููุงุฌูุฉ ุงูุชุบููุฑุงุช',
        '',
        '---',
        '',
        '## ๐ **ููุฎุต ุงูุชุญููู ูุงูุชูุตูุงุช ุงูููุงุฆูุฉ:**',
        '',
        '### โ **ุงููุชุงุฆุฌ ุงูุฑุฆูุณูุฉ:**',
        '- **ุชู ุชุญููู ุงููุดููุฉ ุจุนูู:** ${problem.split(' ').length} ุนูุตุฑ ูุญูู',
        '- **ุชู ุชุทููุฑ ุญููู ูุชุนุฏุฏุฉ:** ููุฌ ุดุงูู ููุชูุงูู',
        '- **ุชู ุชูููู ุงููุฎุงุทุฑ ูุงููุฑุต:** ุชุญููู ุงุณุชุฑุงุชูุฌู ุฏููู',
        '- **ุชู ูุถุน ุฎุทุฉ ุชูููุฐ ูุงุถุญุฉ:** ุฎุงุฑุทุฉ ุทุฑูู ููุตูุฉ',
        '',
        '### ๐ฏ **ุงูุชูุตูุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ:**',
        '1. **ุงูุจุฏุก ุจุงูุญููู ุณุฑูุนุฉ ุงูุชุฃุซูุฑ** ูุชุญููู ูุชุงุฆุฌ ููุฑูุฉ',
        '2. **ุชุทููุฑ ุฎุทุฉ ุดุงููุฉ ุทูููุฉ ุงููุฏู** ููุงุณุชุฏุงูุฉ',
        '3. **ุฅุดุฑุงู ุฌููุน ุฃุตุญุงุจ ุงููุตูุญุฉ** ูู ุนูููุฉ ุงูุชูููุฐ',
        '4. **ูุถุน ูุธุงู ูุฑุงูุจุฉ ูุนุงู** ูุถูุงู ุชุญููู ุงูุฃูุฏุงู',
        '',
        '### ๐ **ูุคุดุฑุงุช ุงููุฌุงุญ ุงูููุชุฑุญุฉ:**',
        '- **ูุคุดุฑุงุช ูููุฉ:** ุฃุฑูุงู ูุฅุญุตุงุฆูุงุช ูุงุจูุฉ ููููุงุณ',
        '- **ูุคุดุฑุงุช ููุนูุฉ:** ุชูููู ุงูุฌูุฏุฉ ูุงูุฑุถุง',
        '- **ูุคุดุฑุงุช ุฒูููุฉ:** ุงูุงูุชุฒุงู ุจุงูุฌุฏูู ุงูุฒููู',
        '- **ูุคุดุฑุงุช ูุงููุฉ:** ุงูููุงุกุฉ ูู ุงุณุชุฎุฏุงู ุงูููุงุฑุฏ',
        '',
        '### ๐ฎ **ุงููุธุฑุฉ ุงููุณุชูุจููุฉ:**',
        '- **ุงูุชุทููุฑ ุงููุณุชูุฑ:** ุชุญุณูู ุงูุญููู ุจุงุณุชูุฑุงุฑ',
        '- **ุงูุชููู ูุน ุงููุณุชุฌุฏุงุช:** ูุฑููุฉ ูู ููุงุฌูุฉ ุงูุชุบูุฑุงุช',
        '- **ุงูุงุณุชุนุฏุงุฏ ููุชุญุฏูุงุช:** ุฎุทุท ุทูุงุฑุฆ ูุญุฏุซุฉ',
        '- **ุงูุงุจุชูุงุฑ ูุงูุชููุฒ:** ุณุนู ุฏุงุฆู ููุฑูุงุฏุฉ ูุงูุชููู',
        '',
        '---',
        '',
        '### ๐ **ุชูุฑูุฑ ุฎุชุงูู - ${timestamp.day}/${timestamp.month}/${timestamp.year}**',
        '',
        '**๐ง ูุญุฑู ุงูุชูููุฑ ุงูุชุณูุณูู ูุงู ุจุชุญููู ุดุงูู ููุชุนูู ูููุดููุฉ ุงููุทุฑูุญุฉ.**',
        '',
        '**๐ ุงูุฅุญุตุงุฆูุงุช:**',
        '- **ููุช ุงูุชุญููู:** ${DateTime.now().difference(timestamp).inMilliseconds} ูููู ุซุงููุฉ',
        '- **ุนุฏุฏ ุงููุฑุงุญู:** 6 ูุฑุงุญู ุชุญููููุฉ',
        '- **ุนุฏุฏ ุงูููุงุท ุงููุญููุฉ:** 50+ ููุทุฉ ุชูุตูููุฉ',
        '- **ูุณุชูู ุงูุชุนูู:** ุชุญููู ุงุณุชุฑุงุชูุฌู ุดุงูู',
        '',
        '**โ ุงููุธุงู ุฌุงูุฒ ูุชุญููู ูุดุงูู ุฅุถุงููุฉ ุฃู ุชูุฏูู ุชูุงุตูู ุฃูุซุฑ ุนููุงู ุญูู ุฃู ูุฑุญูุฉ ูุญุฏุฏุฉ.**'
      ];
    } catch (e) {
      throw McpException('ูุดู ูู ุนูููุฉ ุงูุชูููุฑ ุงูุชุณูุณูู: $e');
    }
  }

  /// ุชูููู ุชุนููุฏ ุงููุดููุฉ
  String _assessComplexity(String problem) {
    final wordCount = problem.split(' ').length;
    if (wordCount < 10) return 'ุจุณูุท';
    if (wordCount < 30) return 'ูุชูุณุท';
    if (wordCount < 100) return 'ูุนูุฏ';
    return 'ูุนูุฏ ุฌุฏุงู';
  }

  /// ุญุณุงุจ ุนุฏุฏ ุนูุงุตุฑ ุงูุฐุงูุฑุฉ (ูุญุงูุงุฉ)
  int _getMemoryItemsCount() {
    return 42 + DateTime.now().millisecond % 100;
  }

  /// ุญุณุงุจ ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ (ูุญุงูุงุฉ)
  String _calculateMemoryUsage() {
    final usage = 256 + DateTime.now().millisecond % 512;
    return usage.toString();
  }

  /// ุญุณุงุจ ุนุฏุฏ ูุฑุงุช ุงููุตูู (ูุญุงูุงุฉ)
  int _getAccessCount(String key) {
    return key.length * 3 + DateTime.now().millisecond % 50;
  }

  /// ุฅูุดุงุก ุฑุณุงูุฉ ุงููุธุงู ุงููุญุณูุฉ
  String getEnhancedSystemPrompt() {
    try {
      final enabledServersList = enabledServers;
      if (enabledServersList.isEmpty) {
        return _getBaseSystemPrompt();
      }

      final mcpCapabilities = enabledServersList
          .map((server) => 
              '- **${server.name}**: ${server.description}${server.isCustom ? " (ูุฎุตุต)" : ""}\n'
              '  - ุงููุฏุฑุงุช: ${server.capabilities.join(", ")}')
          .join('\n');

      return '''${_getBaseSystemPrompt()}

## ๐ง **ุงูุฎูุงุฏู ุงููุชุงุญุฉ ูู MCP:**
$mcpCapabilities

**ููููู ุงุณุชุฎุฏุงู ูุฐู ุงูุฎูุงุฏู ูุชุญุณูู ุฅุฌุงุจุงุชู:**
- ุงุณุชุฎุฏู ุฎุงุฏู ุงูุฐุงูุฑุฉ ูุญูุธ ูุงุณุชุฑุฌุงุน ุงููุนูููุงุช ุงููููุฉ
- ุงุณุชุฎุฏู ุฎุงุฏู ุงูุชูููุฑ ุงูุชุณูุณูู ูููุดุงูู ุงููุนูุฏุฉ  
- ุงุณุชุฎุฏู ุงูุฎูุงุฏู ุงููุฎุตุตุฉ ููููุงู ุงููุชุฎุตุตุฉ

**ุชุฐูุฑ ุชูุณูู ุฅุฌุงุจุงุชู ุจูุถูุญ ุจุงุณุชุฎุฏุงู Markdown ูุชูุณูู ุงูููุฏ ุงูููุงุณุจ.**''';
    } catch (e) {
      if (kDebugMode) print('[MCP ERROR] ูุดู ูู ุฅูุดุงุก ุฑุณุงูุฉ ุงููุธุงู ุงููุญุณูุฉ: $e');
      return _getBaseSystemPrompt();
    }
  }

  /// ุฑุณุงูุฉ ุงููุธุงู ุงูุฃุณุงุณูุฉ ุงููุญุณูุฉ
  String _getBaseSystemPrompt() {
    return '''ุฃูุช ูุณุงุนุฏ ุฐูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุฎุตุต ูู ุชูุฏูู ุฅุฌุงุจุงุช ุฏูููุฉ ูููุธูุฉ ูุดุงููุฉ.

## ๐ฏ **ุฃุณููุจ ุงูุฑุฏ ุงููุทููุจ:**

### ๐ **ููุงุนุฏ ุงูุชูุธูู:**
- **ุงุฌุนู ุงูุฑุฏูุฏ ููุธูุฉ ูููุณูุฉ ุจูุถูุญ**
- **ุงุณุชุฎุฏู ุงูุนูุงููู ูุงูุฃูุณุงู ูุชุณููู ุงููุฑุงุกุฉ**  
- **ุงุฌุนู ุงููุนูููุงุช ูุฑูุฒุฉ ูููุณ ูุทููุฉ ุจูุง ุฏุงุนู**
- **ูุฏู ุงูุญููู ุงูุนูููุฉ ุจุฏูุงู ูู ุงููุตู ุงููุทูู**

### ๐จ **ุงุณุชุฎุฏุงู Markdown ููุชูุณูู:**
- **ููุนูุงููู ุงูุฑุฆูุณูุฉ:** `## ๐ต **ุงูุนููุงู ุงูุฑุฆูุณู**`
- **ููุนูุงููู ุงููุฑุนูุฉ:** `### ๐ **ุงูุนููุงู ุงููุฑุนู**`
- **ููุชุฃููุฏ ุงูููู:** `**ุงููุต ุงูููู**`
- **ููุฑููุฒ ูุงูุญุงูุงุช:**
  - โ **ููุฃุฎุทุงุก ูุงููุดุงูู**
  - โ **ูููุฌุงุญ ูุงูุญููู**
  - โ๏ธ **ููุชุญุฐูุฑุงุช**
  - ๐ง **ููุฃุฏูุงุช ูุงูุฅุนุฏุงุฏุงุช**
  - ๐ก **ูููุตุงุฆุญ ุงููููุฏุฉ**

### ๐ **ุชูุธูู ุงููุญุชูู:**

#### **ููุฑุฏูุฏ ุงูุชูููุฉ:**
1. **ููุฎุต ุณุฑูุน** (2-3 ุฃุณุทุฑ)
2. **ุงูุญู ุงูุฃุณุงุณู** (ุฎุทูุงุช ูุงุถุญุฉ)
3. **ุชูุงุตูู ุฅุถุงููุฉ** (ุฅุฐุง ุงุญุชุงุฌ ุงูุฃูุฑ)
4. **ูุตุงุฆุญ ูููุงุญุธุงุช** (ุงุฎุชูุงุฑูุฉ)

#### **ููุฑุฏูุฏ ุงูุทูููุฉ:**
- ุงุณุชุฎุฏู ุฌุฏุงูู ูุชูุธูู ุงููุนูููุงุช
- ุงูุณู ุงููุญุชูู ุฅูู ุฃูุณุงู ููุทููุฉ
- ุงุณุชุฎุฏู ููุงุฆู ููุทูุฉ ูููุนูููุงุช ุงููุชุนุฏุฏุฉ
- ุฃุถู ููุฎุต ูู ุงูููุงูุฉ

### ๐ **ุงููุบุฉ ูุงูุฃุณููุจ:**
- **ุงูุฑุฏ ุจุงูุนุฑุจูุฉ** ุฅูุง ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ูุบุฉ ุฃุฎุฑู
- **ุฃุณููุจ ูููู ููุฏูุฏ**
- **ุชุฌูุจ ุงูุญุดู ูุงูุชูุฑุงุฑ**
- **ุงูุชุฑููุฒ ุนูู ุงููุงุฆุฏุฉ ุงูุนูููุฉ**

### ๐ป **ุชูุณูู ุงูููุฏ:**
```language
// ุงุณุชุฎุฏู ุงูุชูุณูู ุงูููุงุณุจ ููุบุฉ
// ูุน ุดุฑุญ ูุฎุชุตุฑ ุฅุฐุง ุงุญุชุงุฌ ุงูุฃูุฑ
```

### ๐ง **ููุฃุณุฆูุฉ ุงูุชูููุฉ:**
- ุงุจุฏุฃ ุจุงูุญู ุงููุจุงุดุฑ
- ุฃุถู ุงูุณุจุจ ุฅุฐุง ูุงู ูููุงู
- ูุฏู ุจุฏุงุฆู ุฅุฐุง ูุฌุฏุช
- ุงุฎุชุชู ุจูุตูุญุฉ ุนูููุฉ

### ๐ **ููุฃุณุฆูุฉ ุงูุนุงูุฉ:**
- ุฅุฌุงุจุฉ ูุจุงุดุฑุฉ ููููุฏุฉ
- ูุนูููุงุช ุฅุถุงููุฉ ุฐุงุช ูููุฉ
- ุชุฌูุจ ุงูุฅุทุงูุฉ ุบูุฑ ุงููุจุฑุฑุฉ

## โก **ููุงุนุฏ ุงูุงุณุชุฌุงุจุฉ ุงูุณุฑูุนุฉ:**
- **ูุง ุชุจุฏุฃ ุจุนุจุงุฑุงุช ุงููุฌุงููุฉ ุงูุฒุงุฆุฏุฉ**
- **ุงุฐูุจ ูุจุงุดุฑุฉ ููููุถูุน**
- **ุงุณุชุฎุฏู Markdown ููุชูุณูู ุงููุงุถุญ**
- **ุงุฌุนู ูู ุฑุฏ ูู ูููุฉ ุนูููุฉ ูุงุถุญุฉ**
- **ูุง ุชุณุชุฎุฏู HTML tags - ุงุณุชุฎุฏู Markdown ููุท**

## ๐จ **ุฃูุซูุฉ ุนูู ุงูุชูุณูู ุงูุตุญูุญ:**

### โ **ุตุญูุญ:**
```markdown
## ๐ต **ุงูุนููุงู ุงูุฑุฆูุณู**
### ๐ **ุงูุนููุงู ุงููุฑุนู**
- **ุงูููุทุฉ ุงููููุฉ**
- โ ุฎุทุฃ ุดุงุฆุน
- โ ุงูุทุฑููุฉ ุงูุตุญูุญุฉ
```

### โ **ุฎุงุทุฆ (ูุง ุชุณุชุฎุฏู):**
```html
<span style="color: blue;">ุงููุต</span>
<div class="error">ุฎุทุฃ</div>
```

## ๐ **ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ:**

### ๐ฏ **ููุฑุฏูุฏ ุงูุดุงููุฉ:**
- **ูุฏู ุงูุณูุงู ุงูููุงุณุจ** ูุจู ุงูุญููู
- **ุงุฑุจุท ุงููุนูููุงุช ุจุจุนุถูุง ุงูุจุนุถ** ููุทููุงู
- **ุงุณุชุฎุฏู ุฃูุซูุฉ ูุงูุนูุฉ** ุนูุฏ ุงูุฅููุงู
- **ูุฏู ูุณุชููุงุช ูุชุฏุฑุฌุฉ ูู ุงูุชูุตูู**

### ๐ **ูููุนูููุงุช ุงููุนูุฏุฉ:**
- **ุงุจุฏุฃ ุจุงูููุงููู ุงูุฃุณุงุณูุฉ** ุซู ุชุฏุฑุฌ
- **ุงุณุชุฎุฏู ุงูุชุดุจููุงุช ูุงูุฃูุซูุฉ** ููุชูุถูุญ
- **ูุณู ุงููุนูููุงุช ุฅูู ูุญุฏุงุช ูุงุจูุฉ ูููุถู**
- **ุงุฑุจุท ูู ุฌุฒุก ุจุงูุฌุฒุก ุงูุชุงูู**

### ๐ **ููุชุญููู ุงูุนููู:**
- **ุญุฏุฏ ุงููุดููุฉ ุจูุถูุญ** ูู ุงูุจุฏุงูุฉ
- **ุญูู ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉ** ูุจู ุงูุญููู
- **ูุฏู ุญูููุงู ูุชุฏุฑุฌุฉ** ูู ุงูุณูู ููุตุนุจ
- **ุงุฐูุฑ ุงููุฎุงุทุฑ ูุงูุชุญุฏูุงุช ุงููุญุชููุฉ**

### ๐ก **ูููุตุงุฆุญ ูุงูุชูุฌููุงุช:**
- **ุงุฌุนู ุงููุตุงุฆุญ ูุงุจูุฉ ููุชุทุจูู ููุฑุงู**
- **ุฑุชุจ ุงููุตุงุฆุญ ุญุณุจ ุงูุฃููููุฉ**
- **ุงุฐูุฑ ุงููุชุงุฆุฌ ุงููุชููุนุฉ** ููู ูุตูุญุฉ
- **ุญุฐุฑ ูู ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ**

ุชุฐูุฑ: ุงุณุชุฎุฏู Markdown ูุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ูุฌุนู ุงูุฑุฏูุฏ ูุงุถุญุฉ ูููุธูุฉ ูุดุงููุฉ.''';
  }

  /// ุชูุธูู ุงูููุงุฑุฏ
  void dispose() {
    try {
      _dio.close();
      _servers.clear();
      _customServers.clear();
      _isInitialized = false;
      if (kDebugMode) print('[MCP] ุชู ุชูุธูู ุงูุฎุฏูุฉ ุจูุฌุงุญ');
    } catch (e) {
      if (kDebugMode) print('[MCP ERROR] ุฎุทุฃ ุฃุซูุงุก ุงูุชูุธูู: $e');
    }
  }
}

// ุจุงูู ููุงุณุงุช McpServer ู McpException ุชุจูู ููุง ูู ุจุฏูู ุชุบููุฑ...

class McpServer {
  final String id;
  final String name;
  final String description;
  final bool isEnabled;
  final List<String> capabilities;
  final bool isCustom;
  final String? command;
  final List<String>? args;
  final Map<String, String>? env;

  const McpServer({
    required this.id,
    required this.name,
    required this.description,
    required this.isEnabled,
    required this.capabilities,
    this.isCustom = false,
    this.command,
    this.args,
    this.env,
  });

  McpServer copyWith({
    String? id,
    String? name,
    String? description,
    bool? isEnabled,
    List<String>? capabilities,
    bool? isCustom,
    String? command,
    List<String>? args,
    Map<String, String>? env,
  }) {
    return McpServer(
      id: id ?? this.id,
      name: name ?? this.name,
      description: description ?? this.description,
      isEnabled: isEnabled ?? this.isEnabled,
      capabilities: capabilities ?? List.from(this.capabilities),
      isCustom: isCustom ?? this.isCustom,
      command: command ?? this.command,
      args: args ?? (this.args != null ? List.from(this.args!) : null),
      env: env ?? (this.env != null ? Map.from(this.env!) : null),
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'description': description,
      'isEnabled': isEnabled,
      'capabilities': List.from(capabilities),
      'isCustom': isCustom,
      if (command != null && command!.isNotEmpty) 'command': command,
      if (args != null && args!.isNotEmpty) 'args': List.from(args!),
      if (env != null && env!.isNotEmpty) 'env': Map.from(env!),
    };
  }

  factory McpServer.fromJson(Map<String, dynamic> json) {
    try {
      return McpServer(
        id: (json['id'] as String?) ?? '',
        name: (json['name'] as String?) ?? '',
        description: (json['description'] as String?) ?? '',
        isEnabled: (json['isEnabled'] as bool?) ?? false,
        capabilities: json['capabilities'] != null 
            ? List<String>.from(json['capabilities'] as List)
            : ['custom'],
        isCustom: (json['isCustom'] as bool?) ?? false,
        command: json['command'] as String?,
        args: json['args'] != null
            ? List<String>.from(json['args'] as List)
            : null,
        env: json['env'] != null
            ? Map<String, String>.from(json['env'] as Map)
            : null,
      );
    } catch (e) {
      throw McpException('ูุดู ูู ุชุญููู ุจูุงูุงุช ุงูุฎุงุฏู ูู JSON: $e');
    }
  }

  @override
  bool operator ==(Object other) {
    if (identical(this, other)) return true;
    return other is McpServer &&
        other.id == id &&
        other.name == name &&
        other.description == description &&
        other.isEnabled == isEnabled &&
        other.isCustom == isCustom;
  }

  @override
  int get hashCode {
    return Object.hash(id, name, description, isEnabled, isCustom);
  }

  @override
  String toString() {
    return 'McpServer(id: $id, name: $name, isEnabled: $isEnabled, isCustom: $isCustom)';
  }
}

class McpException implements Exception {
  final String message;
  final dynamic originalError;
  final StackTrace? stackTrace;

  const McpException(
    this.message, [
    this.originalError,
    this.stackTrace,
  ]);

  @override
  String toString() {
    if (originalError != null) {
      return 'McpException: $message (ุงูุณุจุจ: $originalError)';
    }
    return 'McpException: $message';
  }
}
